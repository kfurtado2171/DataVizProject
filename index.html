<!-- U.S. Accidents (2016-2020) -->
<!-- CIS 568 Project -->
<!-- Group 12 -->
<!-- Kyle Furtado & Jonathan Carreiro -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="./libs/d3.js"></script>
    <script src="libs/d3jstopojson.v1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.2.2/dist/echarts.min.js"></script>

    <title>U.S. Accidents (2016-2020)</title>

    <style>
        body {
            background-color: antiquewhite;
        }

        /* h1 & h3 formatting */
        h1,h3 {
            text-align: center;
            font-family: 'Lucida Console', monospace;
            color: #D73026;
        }

        /* container formatting */
        .container{
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* svg formatting */
        .svg {
            width: 1250px;
            height: 750px;
            border: 1px solid #000;
            margin: 10px;
        }

        #tooltip{
            opacity: 0;
            background-color: antiquewhite;
            position: absolute;
            width: auto;
            height: auto;
            font-family: "Lucida Console", monospace;
            align-content: center;
        }

        .tooltipData{
            font-family: "Lucida Console", monospace;
            font-size: small;
        }

        #sliderLabelsContainer {
            font-family: "Lucida Console", monospace;
        }

        /* Style the slider track with visible steps */
        #theSlider {
            width: 100%;
        }

        .slider-container {
            position: relative;
            width: 50%;
            /*margin: 0 auto;*/
            margin-bottom: 50px;
        }

        .slider-label {
            position: absolute;
            bottom: -20px;
            transform: translateX(-50%);
            white-space: nowrap;
        }

        label[for="theSlider"] {
            font-family: 'Lucida Console', monospace;
            font-size: 15pt;
            font-weight: bold;
        }

        #sliderLabel {
            font-family: 'Lucida Console', monospace;
            font-size: 20pt;
            font-weight: bold;
            color: #015CC8;
        }

        .fig1 {
            margin-bottom: -10%; /* Adjust as needed */
        }

    </style>
</head>

<body>
    <!-- page headings -->
    <h1>U.S. Accidents (2016-2020)</h1>
    <h3>Kyle Furtado & Jonathan Carreiro</h3>

    <div id="tooltip"></div>

    <!-- svg container -->
    <div class="container">
        <h1>U.S. Total Accidents per 100,000 Population<br>(2016-2020)</h1>
        <div class="fig1"></div>

        <label for="theSlider" >Display Year</label>
        <span id="sliderLabel">2020</span>
        <datalist id="yearList">
            <option value="2016"></option>
            <option value="2017"></option>
            <option value="2018"></option>
            <option value="2019"></option>
            <option value="2020"></option>
        </datalist>

        <div class="slider-container">
            <input type="range" value="2020" min="2016" max="2020" id="theSlider" step="1">
            <div id="sliderLabelsContainer"></div>
        </div>


        <h1>Proportion of U.S. Accident Scenes<br>(2016-2020)</h1>
        <div id="fig2" style="width: 85%; height: 800px;"></div>


        <!-- choropleth svg creation -->
<!--        <svg id="svg-choropleth" class="svg">-->


<!--        </svg>-->

<!--        <h1>Bar Chart of U.S. Accidents (2016-2020)</h1>-->
<!--        &lt;!&ndash; barchart svg creation &ndash;&gt;-->
<!--        <svg id="svg-barchart" class="svg">-->

<!--        </svg>-->

    </div>

    <script>
        // dimension of the page
        const window_dims = {
            width: window.innerWidth,
            height: window.innerHeight
        };

        const svgWidth = window_dims.width/2;
        const svgHeight = window_dims.height/3;


        let svg = d3.select('svg');

        let year = "2020"

        let state_json_2016 = "data/Project_Data_Final/2016_state_data.topojson"
        let state_json_2017 = "data/Project_Data_Final/2017_state_data.topojson"
        let state_json_2018 = "data/Project_Data_Final/2018_state_data.topojson"
        let state_json_2019 = "data/Project_Data_Final/2019_state_data.topojson"
        let state_json_2020 = "data/Project_Data_Final/2020_state_data.topojson"

        //let state_json = "data/Project_Data_Final/2017_state_data.topojson";//"data/2016_state_data.topojson";
        let projection = d3.geoAlbersUsa() //d3.geoAlbersUsa().scale(1300).translate([500, 400])

        //data[0] is loaded data from d3.json(state_2016_json) in promise
        Promise.all([d3.json(state_json_2016), d3.json(state_json_2017), d3.json(state_json_2018), d3.json(state_json_2019), d3.json(state_json_2020)], // asynchronous load of both data sources using promise.all()
            d3.autoType())                                // Auto formatting data
            .then(main)                                   // when data loaded, function main runs.
            .catch(function (error) {
                console.error("Error loading TopoJSON data:", error);
            });


        // -----------------------------CHOROPLETH-----------------------------
        function main(data) {
            // Load topojson data
            let accident_data = data[4];
            //console.log(data[1])

            const generateChoropleth = (topo_data, containerName, width, height, margin = 30) => {
                d3.select("svg").remove()

                const svg = d3.select(containerName).append("svg")
                    .attr("width", width + 50)
                    .attr("height", height);

                const geojson = topojson.feature(topo_data, topo_data.objects[year + '_state_data']);

                //console.log(geojson)
                const geo_generator = d3.geoPath().projection(projection, geojson);

                const colorInterpolator = d3.interpolateRgbBasis(['#d73027', '#fc8d59', '#fee090', '#e0f3f8', '#91bfdb', '#4575b4'].reverse())
                const colorInterpolator2 = d3.interpolateRgbBasis(['#d73027', '#fc8d59', '#fee090', '#e0f3f8', '#91bfdb', '#4575b4'])

                // if the data is scaled using log scale
                const logScale = d3.scaleLog()
                    .domain(d3.extent(geojson.features, (d) => {
                        return d['properties']['Total Accidents']
                    }))

                // if the data is scaled using linear scale
                const linearScale = d3.scaleLinear()
                    .domain(d3.extent(geojson.features, (d) => {
                        return d['properties']['Total Accidents']
                    }))

                const legendWidth = 20; // Width of the legend
                const legendHeight = 20; // Height of each legend item

                // Append a group for the legend
                const legend = svg.append("g")
                    .attr("class", "legend")
                    .attr("transform", `translate(${width - margin - legendWidth - 50},${margin + 350})`);

                // Create the legend rectangles
                legend.selectAll("rect")
                    .data(d3.range(0, 1, 0.1)) // Create 10 legend items
                    .enter()
                    .append("rect")
                    .attr("x", 50)
                    .attr("y", (d, i) => i * legendHeight - 100)
                    .attr("width", legendWidth)
                    .attr("height", legendHeight)
                    .attr("fill", d => colorInterpolator2(d));

                let min_max_total = d3.extent(geojson.features, (d) => {
                        return d['properties']['Total Accidents']
                    })
                console.log(min_max_total)
                let min_total = Math.floor(min_max_total[0])
                let max_total = Math.ceil(min_max_total[1])

                max_total

                // Create the legend labels
                legend.selectAll("text")
                    //.data(['120000-150000', '90000-120000', '60000-90000', '30000-60000', '0-30000'])
                    .data([max_total, '', '', '', '', '', '', '', '', min_total])
                    .enter()
                    .append("text")
                    .attr("x", legendWidth + 60)
                    .attr("y", (d, i) => i * legendHeight + legendHeight / 2 - 100)
                    .attr("dy", "0.35em")
                    .text(d => d);

                const tooltip = d3.select("#tooltip");

                svg.selectAll("path")
                    .data(geojson.features)
                    .enter()
                    .append("path")
                    .attr("d", d => {
                        //console.log(d)
                        //console.log(geo_generator(d));
                        return geo_generator(d)
                    })
                    .attr("fill","antiquewhite")
                    // .exit()

                //console.log(geojson.features[1].properties['Total Accidents'])
                //console.log(geojson['properties']['Total Accidents'])

                    .on("mouseenter", (m, d) => {
                        d3.select('#tooltip')
                            .style("opacity",.8)
                            .style("left",(m.clientX+20).toString()+"px")
                            .style("top",(m.clientY+20).toString()+"px")
                            .html(
                                "<div><strong>Accidents/100k:</strong></div>" +
                                "<div>" +d.properties['Total Accidents'] + "</div>"
                            )

                        // tooltip.transition()
                        //     .duration(200)
                        //     .style("opacity", .9)
                        // tooltip.html(d.properties['Total Accidents'])
                        //     .style("left", m.clientX-10 + "px")
                        //     .style("top", m.clientY-10 + "px");
                    })
                    .on("mousemove", (m, d) => {
                        tooltip.style("opacity", .9)
                    })
                    .on("mouseout", (m, d) => {
                        tooltip.transition()
                            .duration(10)
                            .style("opacity", 0)
                    })
                    .transition()
                    .delay((_,i)=>i*2)
                    .duration(500)
                    //.attr("fill", d => colorInterpolator(linearScale(d.properties['Total Accidents'])))
                    //.attr("fill", "none")
                    //.attr("stroke","black")
                    .attr("stroke-width", "0.5")
                    .attr("fill", d => colorInterpolator(logScale(d.properties['Total Accidents'])))
                    .style("fill",d=>{
                        try{
                            // normal condition
                            return d => colorInterpolator(logScale(d.properties['Total Accidents']));
                        }
                        catch (error)
                        {
                            // in the case of counties with no data;
                            return "white";
                        }
                    })
            }
            generateChoropleth(accident_data, ".fig1", 900, 700)


            // -----------------------------BAR CHART-----------------------------
            // Dummy data for the example
            // const bar_data = [
            //     {y01: 120, y02: 180, y03: 100, y04: 77},
            //     {y01: 60,  y02: 185, y03: 105, y04: 123},
            //     {y01: 100, y02: 215, y03: 110, y04: 131},
            //     {y01: 80,  y02: 230, y03: 105, y04: 231},
            //     {y01: 120, y02: 240, y03: 105, y04: 44}
            // ];

            let scene_data = "data/Project_Data_Final/" + year + "_SceneData.csv";
            //let scene_data = "data/Project_Data_Final/2017_SceneData.csv";
            //let scene_data = "data/Project_Data_Final/2018_SceneData.csv";
            //let scene_data = "data/Project_Data_Final/2019_SceneData.csv";
            //let scene_data = "data/Project_Data_Final/2020_SceneData.csv";



            let values_T = [];
            // let amenityData = [];
            // let bumpData = [];

            function loadData(filename) {
                let amenity_data = [];
                let bump_data = [];
                let crossing_data = [];
                let give_way_data = [];
                let junction_data = [];
                let no_exit_data = [];
                let railway_data = [];
                let roundabout_data = [];
                let station_data = [];
                let stop_data = [];
                let traffic_calming_data = [];
                let traffic_signal_data = [];
                let turning_loop_data = [];
                let other_data = [];

                //let values_T = [];
                // let data = d3.csv(filename);
                // console.log("DATA: " + data);

                // data.forEach(function (d) {
                //     //values_T.push(+d[scene]);
                //     amenityData.push(+d['Amenity']);
                //     bumpData.push(+d['Bump']);


                d3.csv(scene_data).then(function (data){
                    //console.log(data)
                    //console.log(data[0]['Amenity'])
                    data.forEach(function (d) {
                        amenity_data.push(+d['Amenity'])
                        bump_data.push(+d['Bump'])
                        crossing_data.push(+d['Crossing'])
                        give_way_data.push(+d['Give_Way'])
                        junction_data.push(+d['Junction'])
                        no_exit_data.push(+d['No_Exit'])
                        railway_data.push(+d['Railway'])
                        roundabout_data.push(+d['Roundabout'])
                        station_data.push(+d['Station'])
                        stop_data.push(+d['Stop'])
                        traffic_calming_data.push(+d['Traffic_Calming'])
                        traffic_signal_data.push(+d['Traffic_Signal'])
                        turning_loop_data.push(+d['Turning_Loop'])
                        other_data.push(+d['Other'])
                    });

                //console.log("BUMP DATA: " + bump_data)
                //console.log("OTHER_DATA: " + other_data)

                //return values_T;


            // let amenityData = [];
            // loadData(scene_data_2016, 'Amenity')
            //     .then((result) => {
            //         //amenityData = result;
            //         console.log("RESULT: " + result);
            //
            //
            // console.log("AMENITY DATA: " + amenityData)

            // Initialize ECharts instance
            var echartsInstance = echarts.init(document.getElementById('fig2'));

            var customColors = [
                '#01084f',
                '#391954',
                '#631e50',
                '#a73c5a',
                '#ff7954',
                '#FDC2B0',
                '#F4CB67',
                '#d6d727',
                '#a7e237',
                '#37bd79',
                '#79ccb3',
                '#92cad1',
                '#308fac',
                '#D3D3D3'
            ];

            // ECharts option
            var option = {
                color: customColors, // Set the custom color palette
                tooltip: {
                    trigger: 'item',
                    position: [1000,65],
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {},
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    name: 'Proportion',
                    nameLocation: 'middle',
                    nameGap: 25,
                    nameTextStyle: {
                        fontSize: 20,
                    },
                    type: 'value',
                    max: 1
                },
                yAxis: {
                    name: 'State',
                    nameLocation: 'middle',
                    nameGap: 40,
                    nameTextStyle: {
                        fontSize: 20,
                    },
                    type: 'category',
                    axisLabel: {
                        interval: 0, // Set to 0 to display all labels
                    },
                    //data: ['AK', 'AL', 'AR', 'AZ', 'CA', 'CO', 'CT',]
                    data: ['AL', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'DC', 'FL', 'GA', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD', 'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ', 'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC', 'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY']
                },

                series: [
                    {
                        name: 'Amenity',
                        type: 'bar',
                        stack: 'total',
                        label: {
                            show: false
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        //data: [321, 302, 301, 334, 390, 330, 320]
                        data: amenity_data
                    },
                    {
                        name: 'Bump',
                        type: 'bar',
                        stack: 'total',
                        label: {
                            show: false
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        //data: [120, 132, 101, 134, 90, 230, 210]
                        data: bump_data
                    },
                    {
                        name: 'Crossing',
                        type: 'bar',
                        stack: 'total',
                        label: {
                            show: false
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        //data: [220, 182, 191, 234, 290, 330, 310]
                        data: crossing_data
                    },
                    {
                        name: 'Give_Way',
                        type: 'bar',
                        stack: 'total',
                        label: {
                            show: false
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        //data: [150, 212, 201, 154, 190, 330, 410]
                        data: give_way_data
                    },
                    {
                        name: 'Junction',
                        type: 'bar',
                        stack: 'total',
                        label: {
                            show: false
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        //data: [820, 832, 901, 934, 1290, 1330, 1320]
                        data: junction_data
                    },
                    {
                        name: 'No_Exit',
                        type: 'bar',
                        stack: 'total',
                        label: {
                            show: false
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        //data: [952, 1125, 543, 3520, 1477, 820, 1430]
                        data: no_exit_data
                    },
                    {
                        name: 'Railway',
                        type: 'bar',
                        stack: 'total',
                        label: {
                            show: false
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        //data: [862, 446, 2015, 1025, 389, 533, 262]
                        data: railway_data
                    },
                    {
                        name: 'Roundabout',
                        type: 'bar',
                        stack: 'total',
                        label: {
                            show: false
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        //data: [245, 724, 2437, 243, 4587, 1722, 1472]
                        data: roundabout_data
                    },
                    {
                        name: 'Station',
                        type: 'bar',
                        stack: 'total',
                        label: {
                            show: false
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        //data: [432, 1476, 2574, 786, 732, 435, 3573]
                        data: station_data
                    },
                    {
                        name: 'Stop',
                        type: 'bar',
                        stack: 'total',
                        label: {
                            show: false
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        //data: [1054, 367, 2345, 532, 3453, 2587, 234]
                        data: stop_data
                    },
                    {
                        name: 'Traffic_Calming',
                        type: 'bar',
                        stack: 'total',
                        label: {
                            show: false
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        //data: [324, 2420, 424, 3742, 245, 2420, 3750]
                        data: traffic_calming_data
                    },
                    {
                        name: 'Traffic_Signal',
                        type: 'bar',
                        stack: 'total',
                        label: {
                            show: false
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        //data: [214, 832, 573, 243, 3542, 1534, 4243]
                        data: traffic_signal_data
                    },
                    {
                        name: 'Turning_Loop',
                        type: 'bar',
                        stack: 'total',
                        label: {
                            show: false
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        //data: [945, 674, 762, 543, 1125, 3753, 1235]
                        data: turning_loop_data
                    },
                    {
                        name: 'Other',
                        type: 'bar',
                        stack: 'total',
                        label: {
                            show: false
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        //data: [945, 674, 762, 543, 1125, 3753, 1235]
                        data: other_data
                    }
                ]
            };
            // Set the option and render the chart
            echartsInstance.setOption(option);
            //})
                });
            }
            loadData(scene_data)

            function update(changedYear){
                year = String(changedYear)
                if(changedYear == 2016){
                    accident_data = data[0]
                } else if(changedYear == 2017){
                    accident_data = data[1]
                }else if(changedYear == 2018){
                    accident_data = data[2]
                }else if(changedYear == 2019){
                    accident_data = data[3]
                }else{
                    accident_data = data[4]
                }

                scene_data = "data/Project_Data_Final/" + changedYear + "_SceneData.csv";

                generateChoropleth(accident_data, ".fig1", 900, 700)
                loadData(scene_data)
            }

            let slider = document.querySelector("#theSlider")
            let sliderLabel = document.querySelector("#sliderLabel");
            let sliderLabelsContainer = document.querySelector("#sliderLabelsContainer");
            updateSliderLabels();
            slider.addEventListener("change",()=>{
                const newYear = +slider.value; // get the value of the slider
                //console.log(newYear)
                sliderLabel.textContent = newYear;
                update(newYear);
                updateSliderLabels();
            })

            function updateSliderLabels() {
                sliderLabelsContainer.innerHTML = "";
                const minYear = +slider.min;
                const maxYear = +slider.max;
                const step = +slider.step;

                for (let year = minYear; year <= maxYear; year += step) {
                    const label = document.createElement("div");
                    label.classList.add("slider-label");
                    label.textContent = year;
                    label.style.left = ((year - minYear) / (maxYear - minYear) * 100) + "%";
                    sliderLabelsContainer.appendChild(label);
                }
            }
        }



    </script>

</body>

</html>
